---
title: Redis zset实际应用场景
date: 2024-03-24 00:12:06
tags: Redis
---

到底什么场景需要使用zset？ 

首先zset是一个集合，集合里每个元素都有一个得分（score），支持按照得分对元素进行排序。如果2个元素的得分相同，那么他们按照元素string大小排序。所以内部实现肯定有2个结构：hash表&&skiplist，hash表用来维护元素唯一性，并提供O(1)级别的查询复杂度；skiplist用于排序，时间复杂度最坏O(N)。

那么有哪些场景适合使用呢？典型就是按照时间排序的场景，比我见到的：
* 协作文档编辑房间层
    * 每个编辑房间都有一批websockeet长链接，对应一批用户端。有人加入，就要进入这个房间；离开或者心跳过期，就移出房间。这里的需求是“查询心跳时间最久远的链接，然后移除它们”，以及“有用户上报心跳，就从更新心跳时间”。心跳时间就是score，链接本身作为集合元素。
    * 房间内经常有事件发生（有人加入/离开，有人编辑），特别是编辑事件，非常依赖时间顺序。编辑事件顺序错乱，直接影响用户的文档内容。
        * 同样的，以时间为socre，存储房间内的事件；但是为了方便删除旧事件，也为了避免一个房间内事件过多（500人持续几天编辑，每人每天编辑几次，总事件可能上万），把一段时间内的事件放到一个zset里。
        * “获取房间内最近事件”时，先根据时间间隔生成房间zset的key，然后去每个zset里拉数据。拉到最后一个zset时，还要指定时间戳，因为遍历前面几个zset时，可能有新的事件进入最后一个zset（这些事件是要排除在外的，它们晚于接口指定的时间点）
* 通用的延迟队列
    * 主调方要往延迟队列里加入任务，顺序不依照任务生效时间排序，就很适合zset。相比于房间层这种并发量极高的场景，延迟队列其实完全可以用mysql或者别的什么数据库。这个场景有些牵强。