---
title: redis持久化/真的是一个值得讨论的话题吗
date: 2021-04-11 23:59:16
tags: redis
---


我一向不关注redis在持久化方面的特性，甚至不知道它是何种方式完成持久化。既然redis是个内存的key value，感觉理解了基本的数据结构原理、网络io模式和集群分片的特性就足够了。

reids持久化实在是没什么卵用。或者说一般人不用。我不信有什么业务是真真正正把redis当持久化存储来用。缓存、kv才是它的领率。

但是我的同事有时就喜欢甩一两个我不懂的redis持久化名词，次数多了，我都觉得烦。所以专门来了解下持久化的话题，下次再有人提起，我就可以不屑一顾了。

## 官方文档怎么说

- 官方文档 [redis persistance](https://redis.io/topics/persistence)
- 作者博客 [Redis persistence demystified](http://oldblog.antirez.com/post/redis-persistence-demystified.html)

* RDB(Redis Database) 定时快照
  * 每隔一段时间，fork一个子进程，把父进程的内存数据全部copy到磁盘文件。将来server重启，直接把数据从磁盘加载到内存即可
  * 优点
    * 得益于copy on write机制，fork并不会拷贝出完整的内存。所以fork本身的开销较少
    * 父子进程分开调度，所以也不会影响到各种请求处理。服务器一般是多核，父子进程出现资源竞争、调度竞争的可能很小
    * 拷贝的数据比较精确，内存有啥就copy啥，不会出现冗余的磁盘占用
    * 如果数据量比较小，可以很快完成server重启
  * 不足
    * fork的开销还是有的，比AOF的fsync要大
    * 整个流程比较重，fork、扫描全局key、组织数据格式输出到备份文件，时效性略低

* AOF(append only file) 增量持久化
  * 把写操作按照执行顺序，追加到磁盘文件里。server重启时，重放一边命令
  * 优点
    * 某些场景下，比较省磁盘空间。比如一条命令引起了太多的数据删除，AOF的开销明显比RDB要少
    * 时效性较强。“向日志追加一条命令”，代价真的很小。即使每次write都去追加一条命令，也没有很多的开销
  * 不足
    * 长时间的AOF可能会导致过大的日志文件。持久化日志将变成一个很冗余的文件。

* No persistance 完全不开启持久化
  * 我觉得大多数应用，不开持久化也没有问题

* RDB+AOF
  * RDB持久化的数据非常准确，就是某个时刻的内存快照；但是天生会有延迟，持久化周期的长短，影响到RDB数据和内存数据的同步延迟
  * AOF几乎没有延迟，因为每次写操作都可以直接把命令记录下来；但是日志文件一般会比较大，数据恢复起来也会慢一些
  * 这两个机制可以同时开启，产生某种神秘的互补（我真是觉得没必要）


