---
title: 后台常见策略-服务限流
date: 2024-03-23 23:58:32
tags: 后台常见策略
---

后台服务领域内有很多通用的策略，他们的本质往往很简单，只是长时间不接触就会被我遗忘掉。这里总结下服务限流。

长久以来我只记得住令牌桶算法，它支持匀速发token，也允许有突发流量，就很完美。但这是算法角度，还有工程实践角度需要考虑：比如每次请求令牌，都要发起服务调用吗（也可能是redis之类的存储调用）？

在高性能场景下，特别是公司级基础服务，一定是把大量逻辑放到SDK，服务端只承担一定的限流规则记录&&同步功能。简单分为这几种模式：
* 单次分配。每次查询是否限流，都去发起服务调用。可以想象这在高性能场景下是不可能的，白白增加主调方耗时&&基础服务负载压力。
* 预分配。SDK定期从基础服务获取一定数量的令牌，然后主调方在本地就能判断是否需要限流。这就非常的高性能了，但是也有问题：不够精确。可能主调方的流量不均衡，大家需要的令牌数量不一致，如果预分配的策略不合适（均匀分配/按权重等），可能产生误判。
* 先消费，后结算。SDK直接本地决定是否限流，然后定期地/异步地去基础服务里结算：我用了多少个令牌，下次还能用多少个？好处是可以应对突发流量，快速抢占令牌；坏处是，可能产生超额消费令牌。**据某些分析**，整体流量较低时，先消费后结算的方式不容易触发超额消费，反而有自己的优势：可以应对突发流量。

世界上的事情大多不是非黑即白，总是你中有我，我中有你。比如司内就有人把第二/三种模式混合使用，流量较低时，关注突发流量，使用模式三；较高时，关注超额问题，使用模式二。但是我觉得很花哨，不知道真实效果如何。